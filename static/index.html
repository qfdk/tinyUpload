<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tar.tn - ÁÆÄÂçï‰∏ä‰º†, Simple Is Beautiful</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <link rel="stylesheet" href="static/style.css">
    <style>
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            backdrop-filter: blur(2px);
        }

        .confirm-dialog-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 300px;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .confirm-dialog.active .confirm-dialog-content {
            transform: translateY(0);
        }

        .confirm-dialog-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .confirm-yes {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .confirm-no {
            background: #9e9e9e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-item {
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .file-item.deleting {
            opacity: 0;
            transform: translateX(20px);
        }
    </style>
</head>
<body>
<div class="container">
    <header class="site-header">
        <h1 class="site-title">Tar.tn</h1>
        <p class="site-description">ÁÆÄÂçï‰∏ä‰º†, Simple Is Beautiful</p>
    </header>

    <div class="upload-area" id="dropZone">
        <div class="upload-icon">üì¶</div>
        <p>ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</p>
        <button class="button" id="selectButton">ÈÄâÊã©Êñá‰ª∂</button>
        <input type="file" id="fileInput" style="display: none">

        <div id="uploadProgress">
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="status-text"></div>
        </div>

        <div id="uploadResult">
            <h3>‰∏ä‰º†ÊàêÂäüÔºÅ</h3>
            <div id="resultContent"></div>
            <button class="button copy-button" id="copyButton">Â§çÂà∂‰ø°ÊÅØ</button>
        </div>
    </div>

    <div class="shortcuts">
        <h3>ÂëΩ‰ª§Ë°åÂø´Êç∑Êìç‰Ωú</h3>
        <p>‰∏ä‰º†Êñá‰ª∂Ôºö<code id="uploadCommand">curl -T Êñá‰ª∂Âêç example.com</code></p>
        <p>‰∏ãËΩΩÊñá‰ª∂Ôºö<code id="downloadCommand">curl -O https://example.com/xxxx/Êñá‰ª∂Âêç</code></p>
        <p>Âà†Èô§Êñá‰ª∂Ôºö<code id="deleteCommand">curl -X DELETE "https://example.com/delete/xxxx/Êñá‰ª∂Âêç?code=Âà†Èô§Á†Å"</code>
        </p>
    </div>

    <div class="file-list" id="fileList"></div>
</div>

<script>
    // ÂÖ®Â±ÄÂèòÈáèÂíåÁä∂ÊÄÅ
    const baseUrl = window.location.origin;
    const APP_STATE = {
        isUploading: false,
        pendingDeletions: new Set()
    };

    // DOM ÂÖÉÁ¥†ÁºìÂ≠ò
    const DOM = {
        dropZone: document.getElementById('dropZone'),
        fileInput: document.getElementById('fileInput'),
        selectButton: document.getElementById('selectButton'),
        uploadProgress: document.getElementById('uploadProgress'),
        progressBar: document.querySelector('.progress-bar-fill'),
        statusText: document.querySelector('.status-text'),
        uploadResult: document.getElementById('uploadResult'),
        resultContent: document.getElementById('resultContent'),
        fileList: document.getElementById('fileList'),
        copyButton: document.getElementById('copyButton')
    };

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
        initializeUI();
        setupEventListeners();
        setupXHRProgress();
        loadFileList();
    });

    // ÂàùÂßãÂåñ UI
    function initializeUI() {
        document.getElementById('uploadCommand').textContent = `curl -T Êñá‰ª∂Âêç ${window.location.host}`;
        document.getElementById('downloadCommand').textContent = `curl -O ${baseUrl}/xxxx/Êñá‰ª∂Âêç`;
        document.getElementById('deleteCommand').textContent =
            `curl -X DELETE "${baseUrl}/delete/xxxx/Êñá‰ª∂Âêç?code=Âà†Èô§Á†Å"`;
    }

    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
    function setupEventListeners() {
        DOM.selectButton.addEventListener('click', () => DOM.fileInput.click());
        DOM.fileInput.addEventListener('change', handleFileInputChange);
        DOM.copyButton.addEventListener('click', copyResult);
        setupDragAndDrop();
    }

    // ËÆæÁΩÆÊãñÊîæÂ§ÑÁêÜ
    function setupDragAndDrop() {
        DOM.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            DOM.dropZone.classList.add('dragover');
        });

        DOM.dropZone.addEventListener('dragleave', () => {
            DOM.dropZone.classList.remove('dragover');
        });

        DOM.dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            DOM.dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                await handleFile(e.dataTransfer.files[0]);
            }
        });
    }

    // Êñá‰ª∂ËæìÂÖ•ÂèòÂåñÂ§ÑÁêÜ
    async function handleFileInputChange(e) {
        if (e.target.files.length > 0) {
            await handleFile(e.target.files[0]);
            e.target.value = '';
        }
    }

    // XHR ËøõÂ∫¶ÁõëÂê¨ËÆæÁΩÆ
    function setupXHRProgress() {
        const originalXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function () {
            const xhr = new originalXHR();
            xhr.upload.addEventListener('progress', handleUploadProgress);
            return xhr;
        };
    }

    // ‰∏ä‰º†ËøõÂ∫¶Â§ÑÁêÜ
    function handleUploadProgress(e) {
        if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            requestAnimationFrame(() => {
                DOM.progressBar.style.width = percent + '%';
                DOM.statusText.textContent = `Â∑≤‰∏ä‰º† ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
            });
        }
    }

    // Êñá‰ª∂Â§ÑÁêÜ
    async function handleFile(file) {
        if (APP_STATE.isUploading) return;
        APP_STATE.isUploading = true;

        try {
            showUploadProgress();
            await uploadFile(file);
        } catch (error) {
            console.error('‰∏ä‰º†Â§±Ë¥•:', error);
            showToast('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
        } finally {
            APP_STATE.isUploading = false;
            hideUploadProgress();
        }
    }

    // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
    function showUploadProgress() {
        DOM.uploadProgress.style.display = 'block';
        DOM.progressBar.style.width = '0%';
        DOM.uploadResult.style.display = 'none';
        DOM.statusText.textContent = 'ÂáÜÂ§á‰∏ä‰º†...';
    }

    // ÈöêËóè‰∏ä‰º†ËøõÂ∫¶
    function hideUploadProgress() {
        DOM.uploadProgress.style.display = 'none';
    }

    // Êñá‰ª∂‰∏ä‰º†
    async function uploadFile(file) {
        const encodedFilename = encodeURIComponent(file.name);
        const response = await fetch(`/${encodedFilename}`, {
            method: 'PUT',
            body: file,
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`‰∏ä‰º†Â§±Ë¥•: ${response.status}`);
        }

        const result = await response.json();
        await handleUploadSuccess(result, file);
    }

    // Â§ÑÁêÜ‰∏ä‰º†ÊàêÂäü
    async function handleUploadSuccess(result, file) {
        const fileInfo = {
            path: result.path,
            filename: result.filename,
            fileSize: file.size,
            uploadTime: new Date().toISOString()
        };

        saveFileInfo(fileInfo, result.deleteCode);
        showUploadResult(result);
        await loadFileList();
    }

    // ‰øùÂ≠òÊñá‰ª∂‰ø°ÊÅØ
    function saveFileInfo(fileInfo, deleteCode) {
        localStorage.setItem(
            `fileInfo_/${fileInfo.path}/${fileInfo.filename}`,
            JSON.stringify(fileInfo)
        );
        if (deleteCode) {
            localStorage.setItem(
                `deleteCode_/${fileInfo.path}/${fileInfo.filename}`,
                deleteCode
            );
        }
    }

    // ÊòæÁ§∫‰∏ä‰º†ÁªìÊûú
    function showUploadResult(result) {
        DOM.uploadResult.style.display = 'block';
        const encodedUrl = `${baseUrl}/${result.path}/${encodeURIComponent(result.filename)}`;
        const displayUrl = `${baseUrl}/${result.path}/${result.filename}`; // ÊòæÁ§∫Áî®ÁöÑURLÔºå‰ΩøÁî®ÂéüÂßãÊñá‰ª∂Âêç
        DOM.resultContent.innerHTML = `
        <p>Êñá‰ª∂ÈìæÊé•: <a href="${encodedUrl}" data-url="${encodedUrl}" target="_blank">${displayUrl}</a></p>
        <p>Âà†Èô§Á†Å: ${result.deleteCode}</p>
    `;
    }

    // ÂàõÂª∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    function createConfirmDialog(message) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
            <div class="confirm-dialog-content">
                <p>${message}</p>
                <div class="confirm-dialog-buttons">
                    <button class="confirm-yes">Á°ÆÂÆö</button>
                    <button class="confirm-no">ÂèñÊ∂à</button>
                </div>
            </div>
        `;

            document.body.appendChild(dialog);
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.classList.add('active');
            });

            function closeDialog(result) {
                dialog.style.opacity = '0';
                dialog.classList.remove('active');
                setTimeout(() => {
                    dialog.remove();
                    resolve(result);
                }, 200);
            }

            dialog.querySelector('.confirm-yes').onclick = () => closeDialog(true);
            dialog.querySelector('.confirm-no').onclick = () => closeDialog(false);
        });
    }

    // ÂàõÂª∫Êñá‰ª∂ÂàóË°®È°π
    function createFileListItem(file) {
        const div = document.createElement('div');
        div.className = 'file-item';

        const uploadDate = new Date(file.uploadTime).toLocaleString();
        const encodedFilename = encodeURIComponent(file.filename);

        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.innerHTML = `
        <div class="file-name">${file.filename}</div>
        <div class="file-meta">
            <span class="file-size">${formatFileSize(file.fileSize)}</span>
            <span class="upload-time">${uploadDate}</span>
        </div>
    `;

        const fileActions = document.createElement('div');
        fileActions.className = 'file-actions';

        const downloadLink = document.createElement('a');
        downloadLink.href = `/${file.path}/${encodedFilename}`;
        downloadLink.className = 'button';
        downloadLink.setAttribute('download', file.filename);
        downloadLink.textContent = '‰∏ãËΩΩ';
        fileActions.appendChild(downloadLink);

        if (file.deleteCode) {
            const deleteButton = document.createElement('button');
            deleteButton.className = 'button delete-button';
            deleteButton.textContent = 'Âà†Èô§';
            deleteButton.onclick = (e) => handleDelete(e, file);
            fileActions.appendChild(deleteButton);
        }

        div.appendChild(fileInfo);
        div.appendChild(fileActions);
        return div;
    }

    // Â§ÑÁêÜÂà†Èô§Êìç‰Ωú
    async function handleDelete(event, file) {
        event.preventDefault();
        const button = event.target;
        const fileItem = button.closest('.file-item');

        if (button.disabled || APP_STATE.pendingDeletions.has(fileItem)) {
            return;
        }

        const confirmed = await createConfirmDialog('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü');
        if (!confirmed) return;

        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Âà†Èô§‰∏≠...';
        APP_STATE.pendingDeletions.add(fileItem);

        try {
            await performDelete(file, fileItem);
            showToast('Êñá‰ª∂Â∑≤Âà†Èô§');
        } catch (error) {
            console.error('Âà†Èô§Â§±Ë¥•:', error);
            showToast('Âà†Èô§Â§±Ë¥•: ' + error.message);
            button.disabled = false;
            button.textContent = originalText;
        } finally {
            APP_STATE.pendingDeletions.delete(fileItem);
        }
    }

    // ÊâßË°åÂà†Èô§
    async function performDelete(file, fileItem) {
        const encodedFilename = encodeURIComponent(file.filename);
        const encodedDeleteCode = encodeURIComponent(file.deleteCode);
    
        console.log('Debug info:', {
            originalFilename: file.filename,
            encodedFilename: encodedFilename,
            originalDeleteCode: file.deleteCode,
            encodedDeleteCode: encodedDeleteCode
        });
    
        const response = await fetch(
            `/delete/${file.path}/${encodedFilename}?code=${encodedDeleteCode}`,
            {method: 'DELETE'}
        );
    
        if (!response.ok) {
            throw new Error(await response.text() || 'Âà†Èô§Â§±Ë¥•');
        }
    
        await animateAndRemove(fileItem, file);
    }

    // Âä®ÁîªÁßªÈô§ÂÖÉÁ¥†
    function animateAndRemove(element, file) {
        return new Promise(resolve => {
            element.classList.add('deleting');
            element.style.height = element.offsetHeight + 'px';

            requestAnimationFrame(() => {
                element.style.height = '0';
                element.style.margin = '0';
                element.style.padding = '0';
                element.style.opacity = '0';
            });

            setTimeout(() => {
                element.remove();
                localStorage.removeItem(`deleteCode_/${file.path}/${file.filename}`);
                localStorage.removeItem(`fileInfo_/${file.path}/${file.filename}`);
                checkEmptyFileList();
                resolve();
            }, 300);
        });
    }

    // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
    async function loadFileList() {
        DOM.fileList.innerHTML = '';
        const files = getStoredFiles();

        if (files.length === 0) return;

        const title = document.createElement('h3');
        title.textContent = 'Â∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂';
        title.style.marginBottom = '15px';
        DOM.fileList.appendChild(title);

        const fragment = document.createDocumentFragment();
        files.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime))
            .forEach(file => {
                fragment.appendChild(createFileListItem(file));
            });

        DOM.fileList.appendChild(fragment);
    }

    // Ëé∑ÂèñÂ≠òÂÇ®ÁöÑÊñá‰ª∂
    function getStoredFiles() {
        const files = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('fileInfo_/')) {
                try {
                    const fileInfo = JSON.parse(localStorage.getItem(key));
                    const deleteCode = localStorage.getItem(`deleteCode_/${fileInfo.path}/${fileInfo.filename}`);
                    if (fileInfo && fileInfo.path && fileInfo.filename) {
                        files.push({...fileInfo, deleteCode});
                    }
                } catch (error) {
                    console.error('Error parsing file info:', error);
                    // Ê∏ÖÁêÜÊó†ÊïàÁöÑÂ≠òÂÇ®È°π
                    localStorage.removeItem(key);
                }
            }
        }
        return files;
    }

    // Â§çÂà∂ÁªìÊûú
    async function copyResult() {
        try {
            const link = DOM.resultContent.querySelector('a');
            const displayUrl = link.textContent;
            const deleteCode = DOM.resultContent.textContent.match(/Âà†Èô§Á†Å: (.+)/)?.[1] || '';

            // ÁªÑÁªáÂ§çÂà∂ÂÜÖÂÆπÔºå‰ΩøÁî®ÂéüÂßãÊñá‰ª∂ÂêçÁöÑURL
            const copyText = `Êñá‰ª∂ÈìæÊé•: ${displayUrl}\nÂà†Èô§Á†Å: ${deleteCode}`;

            await navigator.clipboard.writeText(copyText);
            showToast('Â§çÂà∂ÊàêÂäüÔºÅ');
        } catch (err) {
            console.error('Â§çÂà∂Â§±Ë¥•:', err);
            showToast('Â§çÂà∂Â§±Ë¥•');
        }
    }
    
    // ÊòæÁ§∫ Toast Ê∂àÊÅØ
    function showToast(message, duration = 2000) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;

        document.body.appendChild(toast);
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
        });

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // Ê£ÄÊü•Á©∫Êñá‰ª∂ÂàóË°®
    function checkEmptyFileList() {
        const remainingFiles = DOM.fileList.querySelectorAll('.file-item');
        if (remainingFiles.length === 0) {
            const title = DOM.fileList.querySelector('h3');
            if (title) {
                title.style.transition = 'opacity 0.3s ease';
                title.style.opacity = '0';
                setTimeout(() => {
                    if (DOM.fileList.contains(title)) {
                        title.remove();
                    }
                }, 300);
            }
        }
    }

    // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
</body>
</html>
