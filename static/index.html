<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.ServerHost}} - ç®€å•ä¸Šä¼ , Simple Is Beautiful</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
<div class="container">
    <header class="site-header">
        <h1 class="site-title">{{.ServerHost}}</h1>
        <p class="site-description">ç®€å•ä¸Šä¼ , Simple Is Beautiful</p>
    </header>

    <div class="upload-area" id="dropZone">
        <div class="upload-icon">ğŸ“¦</div>
        <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
        <button class="button" id="selectButton">é€‰æ‹©æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display: none">

        <div id="uploadProgress">
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="status-text"></div>
        </div>

        <div id="uploadResult">
            <h3>ä¸Šä¼ æˆåŠŸï¼</h3>
            <div id="resultContent"></div>
            <button class="button copy-button" id="copyButton">å¤åˆ¶ä¿¡æ¯</button>
        </div>
    </div>

    <div class="shortcuts">
        <h3>å‘½ä»¤è¡Œå¿«æ·æ“ä½œ</h3>
        <p>ä¸Šä¼ æ–‡ä»¶ï¼š<code id="uploadCommand">curl -T æ–‡ä»¶å {{.ServerHost}}</code></p>
        <p>ä¸‹è½½æ–‡ä»¶ï¼š<code id="downloadCommand">curl -O {{.Protocol}}://{{.ServerHost}}/xxxx/æ–‡ä»¶å</code></p>
        <p>åˆ é™¤æ–‡ä»¶ï¼š<code id="deleteCommand">curl -X DELETE "{{.Protocol}}://{{.ServerHost}}/delete/xxxx/æ–‡ä»¶å?code=åˆ é™¤ç "</code>
        </p>
    </div>

    <div class="file-list" id="fileList"></div>
</div>

<script>
    // å…¨å±€å˜é‡å’ŒçŠ¶æ€
    const baseUrl = window.location.origin;
    const APP_STATE = {
        isUploading: false,
        pendingDeletions: new Set()
    };

    // DOM å…ƒç´ ç¼“å­˜
    const DOM = {
        dropZone: document.getElementById('dropZone'),
        fileInput: document.getElementById('fileInput'),
        selectButton: document.getElementById('selectButton'),
        uploadProgress: document.getElementById('uploadProgress'),
        progressBar: document.querySelector('.progress-bar-fill'),
        statusText: document.querySelector('.status-text'),
        uploadResult: document.getElementById('uploadResult'),
        resultContent: document.getElementById('resultContent'),
        fileList: document.getElementById('fileList'),
        copyButton: document.getElementById('copyButton')
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        // initializeUI();
        setupEventListeners();
        setupXHRProgress();
        loadFileList();
    });

    // åˆå§‹åŒ– UI
    // function initializeUI() {
    //     document.getElementById('uploadCommand').textContent = `curl -T æ–‡ä»¶å ${window.location.host}`;
    //     document.getElementById('downloadCommand').textContent = `curl -O ${baseUrl}/xxxx/æ–‡ä»¶å`;
    //     document.getElementById('deleteCommand').textContent =
    //         `curl -X DELETE "${baseUrl}/delete/xxxx/æ–‡ä»¶å?code=åˆ é™¤ç "`;
    // }

    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
        DOM.selectButton.addEventListener('click', () => DOM.fileInput.click());
        DOM.fileInput.addEventListener('change', handleFileInputChange);
        DOM.copyButton.addEventListener('click', copyResult);
        setupDragAndDrop();
    }

    // è®¾ç½®æ‹–æ”¾å¤„ç†
    function setupDragAndDrop() {
        DOM.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            DOM.dropZone.classList.add('dragover');
        });

        DOM.dropZone.addEventListener('dragleave', () => {
            DOM.dropZone.classList.remove('dragover');
        });

        DOM.dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            DOM.dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                await handleFile(e.dataTransfer.files[0]);
            }
        });
    }

    // æ–‡ä»¶è¾“å…¥å˜åŒ–å¤„ç†
    async function handleFileInputChange(e) {
        if (e.target.files.length > 0) {
            await handleFile(e.target.files[0]);
            e.target.value = '';
        }
    }

    // XHR è¿›åº¦ç›‘å¬è®¾ç½®
    function setupXHRProgress() {
        const originalXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function () {
            const xhr = new originalXHR();
            xhr.upload.addEventListener('progress', handleUploadProgress);
            return xhr;
        };
    }

    // ä¸Šä¼ è¿›åº¦å¤„ç†
    function handleUploadProgress(e) {
        if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            requestAnimationFrame(() => {
                DOM.progressBar.style.width = percent + '%';
                DOM.statusText.textContent = `å·²ä¸Šä¼  ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
            });
        }
    }

    // æ–‡ä»¶å¤„ç†
    async function handleFile(file) {
        if (APP_STATE.isUploading) return;
        APP_STATE.isUploading = true;

        try {
            showUploadProgress();
            await uploadFile(file);
        } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            showToast('ä¸Šä¼ å¤±è´¥: ' + error.message);
        } finally {
            APP_STATE.isUploading = false;
            hideUploadProgress();
        }
    }

    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    function showUploadProgress() {
        DOM.uploadProgress.style.display = 'block';
        DOM.progressBar.style.width = '0%';
        DOM.uploadResult.style.display = 'none';
        DOM.statusText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
    }

    // éšè—ä¸Šä¼ è¿›åº¦
    function hideUploadProgress() {
        DOM.uploadProgress.style.display = 'none';
    }

    // æ–‡ä»¶ä¸Šä¼ 
    async function uploadFile(file) {
        const encodedFilename = encodeURIComponent(file.name);
        const response = await fetch(`/${encodedFilename}`, {
            method: 'PUT',
            body: file,
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`);
        }

        const result = await response.json();
        await handleUploadSuccess(result, file);
    }

    // å¤„ç†ä¸Šä¼ æˆåŠŸ
    async function handleUploadSuccess(result, file) {
        const fileInfo = {
            path: result.path,
            filename: result.filename,
            fileSize: file.size,
            uploadTime: new Date().toISOString()
        };

        saveFileInfo(fileInfo, result.deleteCode);
        showUploadResult(result);
        await loadFileList();
    }

    // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
    function saveFileInfo(fileInfo, deleteCode) {
        localStorage.setItem(
            `fileInfo_/${fileInfo.path}/${fileInfo.filename}`,
            JSON.stringify(fileInfo)
        );
        if (deleteCode) {
            localStorage.setItem(
                `deleteCode_/${fileInfo.path}/${fileInfo.filename}`,
                deleteCode
            );
        }
    }

    // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
    function showUploadResult(result) {
        DOM.uploadResult.style.display = 'block';
        const encodedUrl = `${baseUrl}/${result.path}/${encodeURIComponent(result.filename)}`;
        const displayUrl = `${baseUrl}/${result.path}/${result.filename}`; // æ˜¾ç¤ºç”¨çš„URLï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å
        DOM.resultContent.innerHTML = `
        <p>æ–‡ä»¶é“¾æ¥: <a href="${encodedUrl}" data-url="${encodedUrl}" target="_blank">${displayUrl}</a></p>
        <p>åˆ é™¤ç : ${result.deleteCode}</p>
    `;
    }

    // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
    function createConfirmDialog(message) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
            <div class="confirm-dialog-content">
                <p>${message}</p>
                <div class="confirm-dialog-buttons">
                    <button class="confirm-yes">ç¡®å®š</button>
                    <button class="confirm-no">å–æ¶ˆ</button>
                </div>
            </div>
        `;

            document.body.appendChild(dialog);
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.classList.add('active');
            });

            function closeDialog(result) {
                dialog.style.opacity = '0';
                dialog.classList.remove('active');
                setTimeout(() => {
                    dialog.remove();
                    resolve(result);
                }, 200);
            }

            dialog.querySelector('.confirm-yes').onclick = () => closeDialog(true);
            dialog.querySelector('.confirm-no').onclick = () => closeDialog(false);
        });
    }

    // åˆ›å»ºæ–‡ä»¶åˆ—è¡¨é¡¹
    function createFileListItem(file) {
        const div = document.createElement('div');
        div.className = 'file-item';

        const uploadDate = new Date(file.uploadTime).toLocaleString();
        const encodedFilename = encodeURIComponent(file.filename);

        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.innerHTML = `
        <div class="file-name">${file.filename}</div>
        <div class="file-meta">
            <span class="file-size">${formatFileSize(file.fileSize)}</span>
            <span class="upload-time">${uploadDate}</span>
        </div>
    `;

        const fileActions = document.createElement('div');
        fileActions.className = 'file-actions';

        const downloadLink = document.createElement('a');
        downloadLink.href = `/${file.path}/${encodedFilename}`;
        downloadLink.className = 'button';
        downloadLink.setAttribute('download', file.filename);
        downloadLink.textContent = 'ä¸‹è½½';
        fileActions.appendChild(downloadLink);

        if (file.deleteCode) {
            const deleteButton = document.createElement('button');
            deleteButton.className = 'button delete-button';
            deleteButton.textContent = 'åˆ é™¤';
            deleteButton.onclick = (e) => handleDelete(e, file);
            fileActions.appendChild(deleteButton);
        }

        div.appendChild(fileInfo);
        div.appendChild(fileActions);
        return div;
    }

    // å¤„ç†åˆ é™¤æ“ä½œ
    async function handleDelete(event, file) {
        event.preventDefault();
        const button = event.target;
        const fileItem = button.closest('.file-item');

        if (button.disabled || APP_STATE.pendingDeletions.has(fileItem)) {
            return;
        }

        const confirmed = await createConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ');
        if (!confirmed) return;

        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'åˆ é™¤ä¸­...';
        APP_STATE.pendingDeletions.add(fileItem);

        try {
            await performDelete(file, fileItem);
            showToast('æ–‡ä»¶å·²åˆ é™¤');
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            showToast('åˆ é™¤å¤±è´¥: ' + error.message);
            button.disabled = false;
            button.textContent = originalText;
        } finally {
            APP_STATE.pendingDeletions.delete(fileItem);
        }
    }

    // æ‰§è¡Œåˆ é™¤
    async function performDelete(file, fileItem) {
        const encodedFilename = encodeURIComponent(file.filename);
        const encodedOriginalFilename = encodeURIComponent(file.originalFilename);
        const encodedDeleteCode = encodeURIComponent(file.deleteCode);

        console.log('Debug info:', {
            filename: file.filename,
            originalFilename: file.originalFilename,
            encodedFilename: encodedFilename,
            encodedOriginalFilename: encodedOriginalFilename,
            deleteCode: file.deleteCode,
            encodedDeleteCode: encodedDeleteCode
        });

        await fetch(
            `/delete/${file.path}/${encodedFilename}?code=${encodedDeleteCode}&original=${encodedOriginalFilename}`,
            {method: 'DELETE'}
        );

        await animateAndRemove(fileItem, file);
    }

    // åŠ¨ç”»ç§»é™¤å…ƒç´ 
    function animateAndRemove(element, file) {
        return new Promise(resolve => {
            element.classList.add('deleting');
            element.style.height = element.offsetHeight + 'px';

            requestAnimationFrame(() => {
                element.style.height = '0';
                element.style.margin = '0';
                element.style.padding = '0';
                element.style.opacity = '0';
            });

            setTimeout(() => {
                element.remove();
                localStorage.removeItem(`deleteCode_/${file.path}/${file.filename}`);
                localStorage.removeItem(`fileInfo_/${file.path}/${file.filename}`);

                // æ¸…é™¤ä¸Šä¼ ç»“æœåŒºåŸŸ
                DOM.uploadResult.style.display = 'none';
                DOM.resultContent.innerHTML = '';

                checkEmptyFileList();
                resolve();
            }, 300);
        });
    }

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    async function loadFileList() {
        DOM.fileList.innerHTML = '';
        const files = getStoredFiles();

        if (files.length === 0) return;

        const title = document.createElement('h3');
        title.textContent = 'å·²ä¸Šä¼ çš„æ–‡ä»¶';
        title.style.marginBottom = '15px';
        DOM.fileList.appendChild(title);

        const fragment = document.createDocumentFragment();
        files.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime))
            .forEach(file => {
                fragment.appendChild(createFileListItem(file));
            });

        DOM.fileList.appendChild(fragment);
    }

    // è·å–å­˜å‚¨çš„æ–‡ä»¶
    function getStoredFiles() {
        const files = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('fileInfo_/')) {
                try {
                    const fileInfo = JSON.parse(localStorage.getItem(key));
                    const deleteCode = localStorage.getItem(`deleteCode_/${fileInfo.path}/${fileInfo.filename}`);
                    if (fileInfo && fileInfo.path && fileInfo.filename) {
                        files.push({...fileInfo, deleteCode});
                    }
                } catch (error) {
                    console.error('Error parsing file info:', error);
                    // æ¸…ç†æ— æ•ˆçš„å­˜å‚¨é¡¹
                    localStorage.removeItem(key);
                }
            }
        }
        return files;
    }

    // å¤åˆ¶ç»“æœ
    async function copyResult() {
        try {
            const link = DOM.resultContent.querySelector('a');
            const displayUrl = link.textContent;
            const deleteCode = DOM.resultContent.textContent.match(/åˆ é™¤ç : (.+)/)?.[1] || '';

            // ç»„ç»‡å¤åˆ¶å†…å®¹ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶åçš„URL
            const copyText = `æ–‡ä»¶é“¾æ¥: ${displayUrl}\nåˆ é™¤ç : ${deleteCode}`;

            await navigator.clipboard.writeText(copyText);
            showToast('å¤åˆ¶æˆåŠŸï¼');
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showToast('å¤åˆ¶å¤±è´¥');
        }
    }

    // æ˜¾ç¤º Toast æ¶ˆæ¯
    function showToast(message, duration = 2000) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;

        document.body.appendChild(toast);
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
        });

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // æ£€æŸ¥ç©ºæ–‡ä»¶åˆ—è¡¨
    function checkEmptyFileList() {
        const remainingFiles = DOM.fileList.querySelectorAll('.file-item');
        if (remainingFiles.length === 0) {
            const title = DOM.fileList.querySelector('h3');
            if (title) {
                title.style.transition = 'opacity 0.3s ease';
                title.style.opacity = '0';
                setTimeout(() => {
                    if (DOM.fileList.contains(title)) {
                        title.remove();
                    }
                }, 300);
            }
        }
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
</body>
</html>
